services:
  alfanjauhari_com_tailscale:
    image: tailscale/tailscale:latest
    container_name: alfanjauhari_com_tailscale
    hostname: alfanjauhari-vps
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - /dev/net/tun:/dev/net/tun
      - tailscale_data:/var/lib/tailscale
    env_file: $RUNTIME_ENV_FILE
    environment:
      TS_STATE_DIR: /var/lib/tailscale
      TS_USERSPACE: "false"
      TS_EXTRA_ARGS: --hostname=alfanjauhari-vps --accept-dns=false
    restart: unless-stopped

  alfanjauhari_com_traefik_tailscale:
    image: traefik:v3.6.6
    container_name: alfanjauhari_com_traefik_tailscale
    network_mode: "service:alfanjauhari_com_tailscale"
    depends_on:
      - alfanjauhari_com_tailscale
    restart: unless-stopped
    command:
      - "--providers.docker.constraints=Label(`traefik.scope`,`admin`)"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entryPoints.admin.address=:443"
      - "--entryPoints.admin.http.tls=true"
      - "--log.level=INFO"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  alfanjauhari_com_traefik:
    image: traefik:v3.6.6
    container_name: alfanjauhari_com_traefik
    restart: unless-stopped
    environment:
      CF_DNS_API_TOKEN: ${CF_DNS_API_TOKEN}
      TRAEFIK_SSL_EMAIL: ${TRAEFIK_SSL_EMAIL:-hi@alfanjauhari.com}
    command:
      - "--log.level=DEBUG"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entryPoints.app.address=:80"
      - "--entryPoints.appsecure.address=:443"
      - "--entryPoints.app.http.redirections.entryPoint.to=appsecure"
      - "--entryPoints.app.http.redirections.entryPoint.scheme=https"
      - "--certificatesresolvers.letsencrypt.acme.email=${TRAEFIK_SSL_EMAIL:-hi@alfanjauhari.com}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/certs/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=0"
      - "--providers.docker.constraints=Label(`traefik.scope`,`public`)"
    ports:
      - "80:80"
      - "443:443"
    networks:
      - web
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - traefik-certs:/certs
    labels:
      - "traefik.enable=true"

      - "traefik.http.middlewares.redirect-www.redirectregex.regex=^https?://alfanjauhari\\.com/(.*)"
      - "traefik.http.middlewares.redirect-www.redirectregex.replacement=https://www.alfanjauhari.com/$${1}"
      - "traefik.http.middlewares.redirect-www.redirectregex.permanent=true"
    depends_on:
      alfanjauhari_com_analytics:
        condition: service_healthy
      alfanjauhari_com_app:
        condition: service_started

  alfanjauhari_com_app:
    image: alfanjauhari/alfanjauhari-com:main
    container_name: alfanjauhari_com_app
    platform: linux/amd64
    env_file: $RUNTIME_ENV_FILE
    expose:
      - "3000"
    volumes:
      - app_data:/usr/src/app
    networks:
      - web
    user: "1000"
    depends_on:
      alfanjauhari_com_db:
        condition: service_healthy
      alfanjauhari_com_redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.scope=public"

      - "traefik.http.routers.app-nonwww.rule=Host(`alfanjauhari.com`)"
      - "traefik.http.routers.app-nonwww.entrypoints=appsecure"
      - "traefik.http.routers.app-nonwww.middlewares=redirect-www"
      - "traefik.http.routers.app-nonwww.tls.certresolver=letsencrypt"

      - "traefik.http.routers.app.rule=Host(`www.alfanjauhari.com`)"
      - "traefik.http.routers.app.entrypoints=appsecure"
      - "traefik.http.routers.app.tls.certresolver=letsencrypt"
      - "traefik.http.services.app.loadbalancer.server.port=3000"

  alfanjauhari_com_db:
    image: postgres:alpine
    container_name: alfanjauhari_com_db
    env_file: $RUNTIME_ENV_FILE
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - web

  alfanjauhari_com_redis:
    image: redis:alpine
    container_name: alfanjauhari_com_redis
    env_file: ${RUNTIME_ENV_FILE:-.env}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "$$REDIS_PASSWORD", "ping"]
      interval: 30s
      timeout: 3s
      retries: 2
    command:
      - redis-server
      - --requirepass
      - ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    networks:
      - web

  alfanjauhari_com_analytics:
    image: ghcr.io/umami-software/umami:latest
    container_name: alfanjauhari_com_analytics
    depends_on:
      alfanjauhari_com_db:
        condition: service_healthy
    env_file: $RUNTIME_ENV_FILE
    networks:
      - web
    healthcheck:
      test: ["CMD-SHELL", "curl http://localhost:3000/api/heartbeat"]
      interval: 5s
      timeout: 5s
      retries: 5
    init: true
    restart: always
    deploy:
      resources:
        limits:
          cpus: 1
          memory: "1g"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.analytics.rule=Host(`analytics.alfanjauhari.com`)"
      - "traefik.http.routers.analytics.entrypoints=appsecure"
      - "traefik.http.routers.analytics.tls.certresolver=letsencrypt"
      - "traefik.http.services.analytics.loadbalancer.server.port=3000"
      - "traefik.scope=public"

  alfanjauhari_com_portainer:
    container_name: alfanjauhari_com_portainer
    image: portainer/portainer-ce:lts
    network_mode: "service:alfanjauhari_com_tailscale"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.scope=admin"
      - "traefik.http.routers.portainer.rule=Host(`portainer.alfanjauhari.com`)"
      - "traefik.http.routers.portainer.entrypoints=admin"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

volumes:
  app_data:
  traefik-certs:
  db_data:
  redis_data:
  portainer_data:
  tailscale_data:

networks:
  web:
    driver: bridge
